// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  password  String
  role      String   @default("user") // user, admin
  image     String?
  aiModelId String?
  aiModel   AIModel? @relation(fields: [aiModelId], references: [id])
  aiPrompt  String?  @db.Text
  botMode   Boolean  @default(false) // Modo bot activado/desactivado
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  payments     Payment[]
  investments  StockInvestment[]

  @@map("users")
}

model AIModel {
  id        String   @id @default(cuid())
  name      String
  type      String   // "OPENAI", "OLLAMA", etc.
  config    Json     // API Key, Base URL, Model Name, etc.
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users     User[]

  @@map("ai_models")
}

model Currency {
  id        String   @id @default(cuid())
  name      String
  code      String   @unique // USD, EUR
  symbol    String   // $, €
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  journals  Journal[]

  @@map("currencies")
}

model Product {
  id        String   @id @default(cuid())
  code      String   @unique
  name      String
  type      String   // "Almacenable", "Servicio"
  cost      Decimal  @default(0)
  price     Decimal  @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("products")
}

model Contact {
  id        String   @id @default(cuid())
  name      String
  vat       String?
  email     String?
  phone     String?
  address   String?
  country   String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  payments  Payment[]

  @@map("contacts")
}

model ScheduledTask {
  id        String   @id @default(cuid())
  name      String
  function  String
  frequency String   // "Minutos", "Hora", "Día", "Semana", "Año"
  interval  Int      @default(1)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("scheduled_tasks")
}

model SystemLog {
  id          Int      @id @default(autoincrement()) // Sequence
  description String
  origin      String
  createdAt   DateTime @default(now())

  @@map("system_logs")
}

model Ticket {
  id          Int      @id @default(autoincrement()) // Sequence
  title       String
  description String
  solution    String?
  status      String   @default("Abierto") // Abierto, En Progreso, Cerrado
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("tickets")
}

model SystemSetting {
  key         String   @id
  value       String
  description String?
  updatedAt   DateTime @updatedAt

  @@map("system_settings")
}

model Journal {
  id        String   @id @default(cuid())
  code      String   @unique
  name      String
  
  currencyId String
  currency   Currency @relation(fields: [currencyId], references: [id])
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  payments  Payment[]
  investments StockInvestment[]
  
  @@map("journals")
}

model Payment {
  id        String   @id @default(cuid())
  code      Int      @unique @default(autoincrement())
  sequence  String   @unique // "IN001", "OUT0001", etc.
  reference String?
  type      String   // "Entrada", "Salida"
  amount    Decimal  @default(0)
  date      DateTime @default(now())
  
  journalId String
  journal   Journal  @relation(fields: [journalId], references: [id])
  
  contactId String?
  contact   Contact? @relation(fields: [contactId], references: [id])

  userId    String?
  user      User?    @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("payments")
}

model StockInvestment {
  id          String   @id @default(cuid())
  symbol      String   // Símbolo de la acción (ej: NKE, MCD, AAPL)
  name        String   // Nombre de la empresa
  shares      Decimal  @default(0) // Cantidad de acciones
  buyPrice    Decimal  @default(0) // Precio de compra por acción
  currentPrice Decimal @default(0) // Precio actual por acción
  totalInvested Decimal @default(0) // Total invertido (shares * buyPrice)
  currentValue Decimal @default(0) // Valor actual (shares * currentPrice)
  profitLoss  Decimal @default(0) // Ganancia/Pérdida
  profitLossPercent Decimal @default(0) // Porcentaje de ganancia/pérdida
  buyDate     DateTime @default(now())
  closeDate   DateTime? // Fecha de cierre de la operación
  closePrice  Decimal?  // Precio de cierre
  
  journalId   String?
  journal     Journal? @relation(fields: [journalId], references: [id])
  
  userId      String?
  user        User?    @relation(fields: [userId], references: [id])
  
  status      String   @default("activa") // "activa", "cerrada"
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("stock_investments")
}

model StockFavorite {
  id          String   @id @default(cuid())
  symbol      String   // Símbolo de la acción
  name        String   // Nombre de la empresa
  note        String?  // Nota opcional
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([symbol])
  @@map("stock_favorites")
}
